<!doctype html>
<html>
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="./bootstrap-5.1.3-dist/css/bootstrap.min.css" rel="stylesheet">

    <title>Hello, world!</title>
    <script src="bundle.js"></script>
    <script type='text/javascript' src='knockout-min.js'></script>

</head>
<body>
    
        <div class="container-fluid" style="height: 30vh;">
            <script src="./bootstrap-5.1.3-dist/js/bootstrap.bundle.min.js" ></script>
            <div class="row">
                <div class="col">
                    <h3>KN4YRM Morse Practice Page</h3>
                </div> 
            </div> 
            <div class="row">
                <div class="col">
                    
                    <div class="input-group mb-3">
                        <span class="input-group-text">WPM</span>
                        <input type="number" class="form-control" aria-label="Username" min="0" data-bind="textInput: wpm">
                        <span class="input-group-text">FWPM</span>
                        <input type="number" class="form-control" aria-label="Server" min="0" data-bind="textInput: fwpm">
                        <span class="input-group-text">FREQ</span>
                        <input type="number" class="form-control" aria-label="Server" min="100" max="1200" step="50" data-bind="textInput: frequency">
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col"> 
                    <div class="btn-toolbar" role="toolbar" aria-label="Toolbar with button groups">
                        <div class="btn-group me-2" role="group" aria-label="Basic mixed styles example"> 
                            <button type="button" class="btn btn-success" data-bind="click: doPlay">Play</button>
                            <button type="button" class="btn btn-warning" data-bind="click: decrementIndex">Back 1</button>

                            <button type="button" class="btn btn-secondary" data-bind="click: incrementIndex">Fwd 1</button>
                            <button type="button" class="btn btn-danger" data-bind="click: doPause">Stop</button>
                            
                        </div>
                        <div class="btn-group me-2" role="group" aria-label="second group">
                            <input type="checkbox" data-bind="checked: showRaw" class="btn-check" id="btnShowRaw" autocomplete="off"/>
                            <label class="btn btn-outline-primary" for="btnShowRaw">Show Raw Text</label>
                            <input type="checkbox" data-bind="checked: hideList" class="btn-check" id="btnHideList" autocomplete="off"/>
                            <label class="btn btn-outline-primary" for="btnHideList">Hide List Words</label>
                        </div>
                        <div class="input-group" aria-label="thirdgroup">
                            <label for="sentencerange" class="form-label" data-bind="text: 'Sentence:' + currentSentanceIndex()"></label>
                            <input type="range" id="sentencerange" class="form-range" aria-label="Input group example"  data-bind="value:currentSentanceIndex, attr:{min:0, max:sentenceMax}, event: {change:changeSentance}">
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col">&nbsp;
                </div>
            </div>
            <div class="row gy-5">
                <div class="col">
                    <div class="input-group">
                        <span class="input-group-text">Text</span>
                        <textarea data-bind="textInput: rawText, visible: showRaw" class="form-control" aria-label="Text"></textarea>
                    </div>
                </div>
            </div>    
            <div class="row">
                <div class="col">&nbsp;
                </div>
            </div>
            
            
        </div>
    
    <div class="container-fluid" style="height: 70vh; overflow-y:auto; overflow-x: hidden;">
        <div class="row flex-fill">
            <div class="col">
                <ul data-bind="foreach: words" class="list-group">
                    <li class="list-group-item" data-bind="css: {active: $index()==$parent.currentIndex()}">
                        <span data-bind="text: $index"> </span>:
                        <span data-bind="text: $data, visible: !$parent.hideList()"> </span>
                        
                    </li>
                </ul>
            </div>
        </div>
    </div>
</body>
<script>
    function vwModel()  {
        var self = this;
        self.rawText= ko.observable("hello world");
        self.wpm=ko.observable(20);
        self.fwpm=ko.observable(20);
        self.frequency=ko.observable(550);
        self.hideList=ko.observable(true);
        self.showRaw=ko.observable(true);
        self.currentSentanceIndex = ko.observable(0);
        self.sentences= ko.computed(function() { 
            var sents = self.rawText().split(".");
            
            sents = sents
            .map((sentence)=>{
                //put the period back
                return (sentence + ".")
                .trim()
                .replace(/-/g," ")
                .replace(/'/g,"")
                .replace(/"/g," ")
                .replace(/:/g,",")
                .replace(/’/g,"")
                .replace(/‘/g,"")
                .replace(/  /g," ")
                .replace(/“/g,"")
                .replace(/”/g,"")
                .replace(/%/g," pct ")
                .replace(/\n/g,"")
                .replace(/—/g,",")
                .replace(/\$/g,"")
                .split(" ")
                .filter(x=>x.length>0);

            })
            .filter(x=>x.length>1 || x[0]!=".");
            console.log(sents);
            
            return sents;

            
        }, self);
        self.sentenceMax = ko.computed(function() {
            return self.sentences().length - 1;
        })
        self.words= ko.computed(function() { 
            
            
            return self.sentences()[self.currentSentanceIndex()];

            
        }, self);
        self.currentIndex = ko.observable(0);
        self.changeSentance = function() {
            self.currentIndex(0);
        }
        self.incrementIndex = function() {
            if (self.currentIndex()<self.words().length-1) {
                self.currentIndex(self.currentIndex()+1);
                console.log(self.currentIndex());
            }
            else 
            {
                //move to next sentence
                if (self.currentSentanceIndex() < self.sentenceMax() ) {
                    self.currentSentanceIndex(Number(self.currentSentanceIndex())+1);
                    self.currentIndex(0);
                }
            }
        }
        self.decrementIndex = function() {
            doPause(()=>{
                if (self.currentIndex()>0 && self.words().length>1) {
                    self.currentIndex(self.currentIndex()-1);
                    console.log(self.currentIndex());
                    self.doPlay();
                 }
            });
            
        }
        self.doPlay = function() {
            doPause(()=>{
                doPlay(self.words()[self.currentIndex()],self.wpm(),self.fwpm(),self.frequency(), self.playEnded)
                console.log('played');
            });
        };
            
        
        self.playEnded = function () {
            console.log('ended');
            if (self.currentIndex()<self.words().length-1) {
                self.incrementIndex();
                self.doPlay();
            } else {
                //move to next sentence
                if (self.currentSentanceIndex() < self.sentenceMax() ) {
                    self.currentSentanceIndex(Number(self.currentSentanceIndex())+1);
                    self.currentIndex(0);
                    self.doPlay();
                }
            }
        }
        self.doPause = function() {
            doPause(()=>{});
        }
    }

    ko.applyBindings(new vwModel());
</script>
</html>